• Cookbook: API changes while using the Functions emulator

  1) In /functions, run `npm run build -- --watch` in one terminal to keep recompiling TypeScript to lib/.
  2) In another terminal, run `FUNCTIONS_EMULATOR_NETWORK_MODE=enabled firebase emulators:start --only functions,firestore,auth,storage`.
     - Storage emulator is required to keep meal uploads and ingredient thumbnails local; otherwise uploads go to prod. Auth emulator keeps dev auth local.
     - Storage emulator now reads permissive rules from storage.rules (dev only); firebase.json points to it (top-level storage.rules + emulator override).
  3) Make changes to functions/src; the watch build updates lib/, and the emulator reloads automatically. Without the build step, new routes won’t exist.

• To run PlateLens locally and test on your iOS/Android devices:

  1. Prep environment

  - In the repo root: npm install --global firebase-tools.
  - cd app && npm install (already done but rerun if deps changed).
  - cd functions && npm install && npm run build so the functions are ready.

  2. Start the backend

  - In /functions, run `FUNCTIONS_EMULATOR_NETWORK_MODE=enabled firebase emulators:start --only functions,firestore,auth,storage`.
    Hosts/ports are set in firebase.json (bound to 0.0.0.0 for LAN access): Functions 5001, Firestore 8080, Auth 9099, Storage 9199.
    OpenAI calls still work because network mode is enabled.
  - If you want to hit it from a phone on the same LAN, set EXPO_PUBLIC_EMULATOR_HOST in app/.env to your machine’s LAN IP (e.g., 192.168.1.23) and restart the app; the emulators are bound to 0.0.0.0 via firebase.json.
    If the phone is NOT on the same network, use your Cloudflare tunnel: cloudflared tunnel --url http://127.0.0.1:5001. Copy the tunnel URL (e.g.,
    https://platelens-dev.example.com) and set EXPO_PUBLIC_API_BASE_URL to that URL in app/.env. Restart the emulator if you change env values.

  3. Run the Expo app

  - Open a new terminal: cd app.
  - Ensure you’re logged into Expo: npx eas login.
  - Start Metro with tunneling so physical devices can connect: npx expo start --tunnel.
    On the simulator/emulator, Firestore/Auth/Storage will use emulators (host 127.0.0.1 or 10.0.2.2).
    On a physical device (same LAN): set EXPO_PUBLIC_EMULATOR_HOST to your machine’s LAN IP (e.g., 192.168.1.23) in app/.env for dev builds; this also sets the Functions base URL automatically.
    Firestore/Auth/Storage all share that host with their own ports (8080/9099/9199). Without that env, a phone will fail to reach 127.0.0.1.
    If Storage emulator causes issues on device, set EXPO_PUBLIC_DISABLE_EMULATOR_STORAGE=true in app/.env to force Storage to prod while keeping Functions/Firestore/Auth on emulators. Logs will show `storage: DISABLED (using prod)` when this is active.
  - Install Expo Go on your device (iOS App Store or Google Play). Scan the QR code shown in the terminal. The app will load and walk through
    splash → notifications → auth → onboarding → plan → paywall → app screens, hitting your tunneled backend.

  4. Test specific flows

  - Push notifications: once your Expo access token is in .env (already done), call the test endpoint:
    curl -X POST https://<your-api-url>/v1/notify/test -H "Content-Type: application/json" -d '{"uid":"test-
    user","title":"Ping","body":"PlateLens reminder"}'
    Make sure you've registered a device via POST /v1/devices/register in the app first.
  - RevenueCat: until offerings are configured, the paywall still uses the mock setStatus('active'). After you set up products/offerings in
    App Store/Play/RevenueCat, swap in real Purchases.purchasePackage logic and run through the paywall in Expo Go using a sandbox Apple/Google
    account.
  - Backend endpoints: with the emulator running you can hit them via Postman/cURL to confirm responses, e.g. curl http://127.0.0.1:5001/
    platelens-3333/us-central1/api/v1/config.

  5. Device builds (optional)

  - Once happy in Expo Go, generate native binaries:
      - npx eas build -p ios --profile development for a TestFlight-ready build (requires Apple CLI login and certificates).
      - npx eas build -p android --profile development to get an APK/AAB.
  - After those succeed, you can submit with eas submit -p ios / -p android using the Play service account JSON from auth.txt.

  Let me know if you run into any errors starting the emulator or Expo tunnel. Once we wire the RevenueCat offerings and Apple Sign In
  credentials, I’ll help integrate the final purchase/auth flows.
